QEMUROOT = ..

SOURCES_LIB = $(QEMUROOT)/cutils.c \
	  dispatch.c
SOURCES_TEST =  translate-test.c

OBJECTS_LIB_BASE := $(basename $(SOURCES_LIB))
OBJECTS_LIB  := $(OBJECTS_LIB_BASE:%=%.o)
OBJECTS_TEST_BASE := $(basename $(SOURCES_TEST))
OBJECTS_TEST := $(OBJECTS_TEST_BASE:%=%.o)

QEMUFLAGS=-I. -I$(QEMUROOT)  \
	-I$(QEMUROOT)/tcg -I$(QEMUROOT)/fpu -I$(QEMUROOT)/include -I$(QEMUROOT)/linux-user \
	-D__STDC_FORMAT_MACROS -D_GNU_SOURCE  -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE \
	-DTCG_PYTHON -DTARGET_X86_64\
	-Wredundant-decls -Wundef -Wendif-labels -Wwrite-strings -fno-strict-aliasing \
	-Wno-sign-compare -Wno-missing-field-initializers -fexceptions $(shell pkg-config --cflags glib-2.0)
QEMULDFLAGS = $(shell pkg-config --libs glib-2.0)

CC = gcc
CXXFLAGS += $(QEMUFLAGS)
CFLAGS += $(QEMUFLAGS) -Wall -Wextra -Wformat -Wformat-security -g -O -fPIC
LDFLAGS += $(QEMULDFLAGS) -g -O
LDFLAGS_SHARED += $(LDFLAGS) -shared

# generated by build.py
MODULES = arm-module.o x86_32-module.o x86_64-module.o mips_32-module.o

all: translate-test libqdis.so

clean:
	rm -f $(OBJECTS_LIB) $(OBJECTS_TEST)

translate-test: $(OBJECTS_LIB) $(OBJECTS_TEST) $(MODULES)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

libqdis.so: $(OBJECTS_LIB) $(MODULES)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS_SHARED)
